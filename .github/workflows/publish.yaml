name: Secure NPM Publish

# âš ï¸ SECURITY: This workflow uses Trusted Publishers (OIDC)
# No long-lived tokens needed - authentication via GitHub identity
# Requires NPM organization setup: https://docs.npmjs.com/trusted-publishers

on:
  # Manual trigger with version bump options
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
        default: 'patch'
      
      dry_run:
        description: 'Dry run (test without publishing)'
        required: false
        type: boolean
        default: false

  # Automatic publish on release tags
  push:
    tags:
      - 'v*.*.*'

# Security: Minimal permissions by default
permissions:
  contents: write  # For creating git commits/tags
  id-token: write  # For OIDC authentication with NPM (Trusted Publishers)
  pull-requests: read

jobs:
  # ============================================
  # JOB 1: Security Audit & Validation
  # ============================================
  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate changelog

      - name: Setup Node.js 20 LTS
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Verify package integrity
        run: |
          echo "ðŸ“¦ Verifying package.json integrity..."
          node -e "JSON.parse(require('fs').readFileSync('package.json'))"
          
      - name: Install dependencies (with audit)
        run: |
          npm ci --ignore-scripts
          
      - name: Run security audit
        run: |
          npm audit --audit-level=moderate
          
      - name: Check for known vulnerabilities
        run: |
          npx audit-ci --moderate
        continue-on-error: true
        
      - name: Validate token list schema
        run: npm test

  # ============================================
  # JOB 2: Build & Test
  # ============================================
  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: security-audit
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js 20 LTS
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --ignore-scripts
        
      - name: Run tests
        run: npm test
        
      - name: Build token list
        run: npm run build
        
      - name: Validate build output
        run: |
          if [ ! -f "build/quickswap-default.tokenlist.json" ]; then
            echo "âŒ Build failed: tokenlist.json not found"
            exit 1
          fi
          
          # Validate JSON structure
          node -e "const list = require('./build/quickswap-default.tokenlist.json'); \
                   if (!list.name || !list.version || !list.tokens) { \
                     throw new Error('Invalid tokenlist structure'); \
                   }"
          
          echo "âœ… Build validation passed"
          
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: tokenlist-build
          path: build/
          retention-days: 7

  # ============================================
  # JOB 3: Version Bump (if manual trigger)
  # ============================================
  version-bump:
    name: ðŸ“ Version Bump
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'workflow_dispatch' && !inputs.dry_run
    timeout-minutes: 5
    
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Configure Git
        run: |
          git config user.name "quickswap-bot"
          git config user.email "bot@quickswap.exchange"
          
      - name: Bump version
        id: bump
        run: |
          echo "Current version: $(node -p "require('./package.json').version")"
          
          npm version ${{ inputs.bump }} -m "chore(release): v%s [skip ci]"
          
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version bumped to: $NEW_VERSION"
          
      - name: Push version commit & tag
        run: |
          git push origin HEAD --follow-tags
          echo "âœ… Pushed v${{ steps.bump.outputs.new_version }}"

  # ============================================
  # JOB 4: Publish to NPM (Secure)
  # ============================================
  publish-npm:
    name: ðŸš€ Publish to NPM
    runs-on: ubuntu-latest
    needs: [build-and-test, version-bump]
    # Run on tags OR manual workflow (skip if dry_run)
    # Note: version-bump is skipped on tag push, so we use always() with extra conditions
    if: |
      always() && 
      needs.build-and-test.result == 'success' &&
      (
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
        (github.event_name == 'workflow_dispatch' && !inputs.dry_run && needs.version-bump.result == 'success')
      )
    timeout-minutes: 10
    
    environment:
      name: npm-production
      url: https://www.npmjs.com/package/@quickswap-defi/token-list
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history
          
      - name: Fetch latest changes (after version bump)
        if: github.event_name == 'workflow_dispatch'
        run: |
          # Fetch the latest commits and tags from the remote
          git fetch origin --tags --force
          # Reset to the latest commit on the branch to get the version bump
          git reset --hard origin/${{ github.ref_name }}
          echo "âœ… Updated to latest commit on ${{ github.ref_name }}"
          
      - name: Verify package version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "ðŸ“¦ Package version: $PACKAGE_VERSION"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            EXPECTED_VERSION="${{ needs.version-bump.outputs.new_version }}"
            echo "Expected version from version-bump job: $EXPECTED_VERSION"
            if [ "$PACKAGE_VERSION" != "$EXPECTED_VERSION" ]; then
              echo "âš ï¸ Warning: Package version doesn't match expected version"
              echo "This might indicate the version bump didn't propagate correctly"
            fi
          fi
          
      - name: Setup Node.js with NPM registry
        uses: actions/setup-node@v4
        with:
          node-version: '24'  # Node 24 required for OIDC publishing (npm/cli#8730)
          registry-url: 'https://registry.npmjs.org/'

      - name: Update npm (required for OIDC)
        run: |
          npm install -g npm@latest
          npm --version
          
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: tokenlist-build
          path: build/
          
      - name: Install dependencies
        run: npm ci --ignore-scripts
        
      - name: Rebuild (ensure consistency)
        run: npm run build
        
      - name: Pre-publish verification
        run: |
          echo "ðŸ“‹ Package details:"
          npm pack --dry-run
          
          echo ""
          echo "ðŸ“¦ Package contents:"
          npm publish --dry-run
          
      - name: Check if version already exists
        id: check_version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "Checking if version $PACKAGE_VERSION already exists..."
          
          if npm view "@quickswap-defi/token-list@$PACKAGE_VERSION" version > /dev/null 2>&1; then
            echo "âš ï¸ Version $PACKAGE_VERSION already exists in npm registry"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âœ… Version $PACKAGE_VERSION is new and can be published"
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          fi
          
      # ðŸš€ PUBLISH with provenance
      - name: Publish to NPM
        if: steps.check_version.outputs.exists == 'false'
        run: |
          npm publish --access public --provenance
          
      - name: Skip publish (version exists)
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "â­ï¸ Skipping publish: version ${{ steps.check_version.outputs.version }} already exists in npm registry"
          echo "If you need to publish a new version, bump the version first."
          
      - name: Get published version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: v${{ steps.version.outputs.version }}
          body: |
            ## ðŸ“¦ NPM Package Published
            
            **Package:** `@quickswap-defi/token-list@${{ steps.version.outputs.version }}`
            **NPM:** https://www.npmjs.com/package/@quickswap-defi/token-list
            
            ### Installation
            ```bash
            npm install @quickswap-defi/token-list@${{ steps.version.outputs.version }}
            ```
            
            ### Verification
            This package was published with [NPM Provenance](https://docs.npmjs.com/generating-provenance-statements) for supply chain security.
            
            Verify authenticity:
            ```bash
            npm view @quickswap-defi/token-list@${{ steps.version.outputs.version }} --json
            ```
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}

  # ============================================
  # JOB 5: Post-Publish Verification
  # ============================================
  verify-publish:
    name: âœ… Verify Publication
    runs-on: ubuntu-latest
    needs: publish-npm
    if: needs.publish-npm.result == 'success'
    timeout-minutes: 5
    
    steps:
      - name: Wait for NPM registry propagation
        run: sleep 30
        
      - name: Verify package is published
        run: |
          PACKAGE_VERSION=$(npm view @quickswap-defi/token-list version)
          echo "âœ… Published version: $PACKAGE_VERSION"
          
          # Verify provenance
          npm view @quickswap-defi/token-list --json | jq '.provenance'
          
      - name: Test installation
        run: |
          mkdir -p /tmp/test-install
          cd /tmp/test-install
          npm init -y
          npm install @quickswap-defi/token-list --ignore-scripts
          
          echo "âœ… Package installation successful"
          
      - name: Notify success
        run: |
          echo "ðŸŽ‰ Publication verified successfully!"
          echo "Package: @quickswap-defi/token-list"
          echo "NPM: https://www.npmjs.com/package/@quickswap-defi/token-list"

