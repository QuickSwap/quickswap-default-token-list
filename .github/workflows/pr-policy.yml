name: PR policy (external token PRs)

# ⚠️ MAINTAINERS: Do not add actions/checkout to this workflow.
# Review security implications before modifying: https://git.io/JcGqL

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  close_external_token_prs:
    name: Close external token list PRs (forks)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Enforce policy
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return;

            // Draft PRs can be legit WIP from maintainers; don't interfere.
            if (pr.draft) return;

            // Only target forks (this is the common vector for unsolicited PRs).
            const isFork = pr.head?.repo?.full_name !== context.repo.owner + "/" + context.repo.repo;
            if (!isFork) return;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = pr.number;

            // Identify whether the PR touches token list data/assets.
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            const touchesTokenList = files.some((f) => {
              const p = f.filename;
              return (
                p.startsWith("src/tokens/") ||
                p.startsWith("assets/") ||
                p === "package.json" ||
                p === "package-lock.json" ||
                p.startsWith("build/")
              );
            });

            if (!touchesTokenList) return;

            // Avoid double-posting the same comment.
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: pull_number,
              per_page: 100,
            });
            const alreadyCommented = comments.some(
              (c) =>
                c.user?.login === "github-actions[bot]" &&
                typeof c.body === "string" &&
                c.body.includes("Unsolicited token listing PRs are not accepted")
            );

            if (!alreadyCommented) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: [
                  "Thanks for the PR.",
                  "",
                  "Unsolicited token listing PRs are not accepted in this repository.",
                  "",
                  "### How to request a listing",
                  "- Contact our BD team first (see `README.md` -> **Token Listing Process**).",
                  "- After BD approval, our team will provide submission instructions.",
                  "",
                  "This PR is being closed to prevent spam. If you have BD approval, please reference it when contacting the team so we can reopen as needed.",
                ].join("\n"),
              });
            }

            // Close the PR. We intentionally do not auto-delete the fork branch.
            await github.rest.pulls.update({
              owner,
              repo,
              pull_number,
              state: "closed",
            });

